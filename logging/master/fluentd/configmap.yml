apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: logging
data:
  fluent.conf: |
    <system>
      <log>
        format json
        time_format %Y-%m-%d
      </log>
    </system>
    @include kubernetes.conf
  
  system.conf: |
    <match fluent.**>
      @type copy
      <store>
        @type elasticsearch
        host "#{ENV['ELASTICSEARCH_HOST']}"
        port "#{ENV['ELASTICSEARCH_PORT']}"
        user "#{ENV['FLUENT_ELASTICSEARCH_USER']}"
        password "#{ENV['FLUENT_ELASTICSEARCH_PASSWORD']}"
        scheme http
        logstash_format true
        logstash_prefix fluentd-info
        logstash_dateformat %Y%m%d
        include_tag_key true
        type_name access_log
        tag_key @log_name
        <buffer>
           flush_interval 5s
        </buffer>
      </store>
      <store>
        @type stdout
      </store>
    </match>

  kubernetes.conf: |
    <source>
      @type forward
      port 9880
      bind 0.0.0.0
    </source>

    <match dee kube-system logging ingress-nginx>
      @type copy
      <store> 
      @type elasticsearch
      @log_level "info"
      with_transporter_log true
      host "#{ENV['ELASTICSEARCH_HOST']}"
      port "#{ENV['ELASTICSEARCH_PORT']}"
      user "#{ENV['ELASTICSEARCH_USER']}"
      password "#{ENV['ELASTICSEARCH_PASSWORD']}"

      scheme http
      #rollover_index true
      #template_name kuber
      #template_file /fluentd/etc/template.mapping
      logstash_format true
      logstash_prefix ${tag}
      include_tag_key true
      type_name access_log
      tag_key @log_name
      #enable_ilm false
      #ilm_policy {}
      #ilm_policy_id "kuber-policy"
      #ilm_policy_overwrite false
      #log_es_400_reason true
      reconnect_on_error true
      reload_on_failure true
      reload_connections false

      <buffer>
          @type file
          path /var/log/fluent/myapp.*.buffer
          flush_interval 5s
      </buffer>
     </store>
     </match>

  template.mapping: |
    {
       "order": 2,
       "index_patterns": [
           "logging*"
       ],
       "settings": {
       "index": {
           "lifecycle": {
           "name": "kuber-policy",
           "rollover_alias": "kuber"
       },
       "codec": "best_compression",
       "routing": {
         "allocation": {
           "require": {
             "box_type": "ssd"
           }
         }
       },
       "refresh_interval": "5s",
       "number_of_shards": "1",
       "number_of_replicas": "2"
      }
    },
    "mappings": {},
    "aliases": {}
    }

