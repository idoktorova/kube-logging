---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: mail-server
  namespace: monitoring
  name: mail-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mail-server
  template:
    metadata:
      labels:
        app: mail-server
    spec:
      containers:
      - image: reachfive/fake-smtp-server
        name: mail-server
        ports:
        - name: "smtp"
          containerPort: 1025
          protocol: TCP
        - name: "http" 
          containerPort: 1080
          protocol: TCP
        resources: {}
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: mail-server
  name: mail-server
  namespace: monitoring
spec:
  ports:
  - name: "smtp"
    port: 1025
    protocol: TCP
    targetPort: "smtp"
  - name: "http-port"
    port: 1080
    protocol: TCP
    targetPort: "http"
  selector:
    app: mail-server
---

#apiVersion: extensions/v1beta1
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/rewrite-target: /$1
    nginx.ingress.kubernetes.io/use-regex: "true"
#    kubernetes.io/tls-acme: "true"
#    ingress.kubernetes.io/force-ssl-redirect: "true"

  name: mail-server
  namespace: monitoring

spec:
#  backend:
#    serviceName: fake-smtp-server
#    servicePort: 1080
#  defaultBackend:
#    service:
#      name: fake-smtp-server
#      port:
#        number: 1080
  rules:
#    http:
#      paths:
#      - backend:
#          serviceName: kibana
#          servicePort: 5601
#        path: /
 # tls:
 # - hosts:
 #   - kibana.itsecforu.ru
 #   secretName: ingress-secret   // This can be created prior if using custom certs
#  - http:
#      paths:
#      - path: /server
#        pathType: Prefix
#        backend:
#          service:
#            name: fake-smtp-server
#            port:
#              number: 1080
  - http:
      paths:
      - path: /mail(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: mail-server
            port:
              number: 1080
